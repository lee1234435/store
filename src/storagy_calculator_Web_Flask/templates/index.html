<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- 카메라 영역 -->
        <div class="camera-section">
            <video id="video" class="camera" autoplay></video>
            <p class="instruction-text">물건의 바코드를 보여주세요</p>
        </div>

        <!-- 정보 영역 -->
        <div class="info-section">
            <h2 class="mb-4">Items List</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Expiry Date</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="items-list">
                    <!-- Items will be dynamically inserted here -->
                </tbody>
            </table>
            <button id="complete-order" class="order-button">결제 완료</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let video;
        let canvas;
        let context;
        const captureInterval = 5000; // 캡처 간격 (밀리초)
        const updateInterval = 500; // 데이터 업데이트 간격 (밀리초)

        function startCamera() {
            video = document.querySelector('#video');
            canvas = document.createElement('canvas');
            context = canvas.getContext('2d');

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    setInterval(captureAndSendImage, captureInterval);
                })
                .catch(error => console.error('Error accessing webcam:', error));
        }

        function captureAndSendImage() {
            if (video.videoWidth > 0 && video.videoHeight > 0) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg');

                fetch('/process_image', {
                    method: 'POST',
                    body: JSON.stringify({ image: imageData }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        console.log('Image sent successfully');
                    } else {
                        console.error('Error sending image');
                    }
                });
            }
        }

        function fetchItems() {
            fetch('/get_items')
                .then(response => response.json())
                .then(data => {
                    const itemsList = document.getElementById('items-list');
                    itemsList.innerHTML = ''; // Clear existing items

                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.name}</td>
                            <td>${item.price}</td>
                            <td>${item.expiry_date}</td>
                            <td>${item.quantity}</td>
                        `;
                        itemsList.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching items:', error));
        }

        // Update the items list every 0.5 seconds
        setInterval(fetchItems, updateInterval);

        // 결제 완료 버튼 클릭 시 데이터베이스 초기화
        document.getElementById('complete-order').addEventListener('click', function() {
            fetch('/reset_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    console.log('Database reset successfully');
                    window.location.href = '/'; // 홈 페이지로 리다이렉트
                } else {
                    console.error('Error resetting database');
                }
            }).catch(error => {
                console.error('Fetch error:', error);
            });
        });

        // 결제 완료 버튼 클릭 시 ROS2 서비스 호출
        document.getElementById('complete-order').addEventListener('click', function() {
        fetch('/order_complete')
            .then(response => {
                if (response.ok) {
                    console.log('결제가 완료되고 ROS2 서비스가 성공적으로 호출되었습니다.');
                    window.location.href = '/'; // 홈 페이지로 리다이렉트
                    print("finish!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
                } else {
                    console.error('ROS2 서비스 호출 중 오류 발생');
                    print("error!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
                }
            }).catch(error => {
                console.error('Fetch 오류:', error);
            });
        });
        window.onload = startCamera;
    </script>
</body>
</html>
